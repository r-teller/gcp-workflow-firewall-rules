name: Terraform Pull Request Validation

on:
  pull_request:
    types: [synchronize, opened, reopened]

# Use a concurrency group to ensure serialized execution
concurrency:
  group: terraform-plan-or-apply
  cancel-in-progress: false

jobs:
  # firewall-rules-lint:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Install jsonlint
  #       run: npm install -g jsonlint

  #     - name: Get list of changed files
  #       id: check_files_changed
  #       uses: actions/github-script@v7
  #       with:
  #         script: |
  #           const script = require('./.github/scripts/terraform-schema-check/get_list_changed_files.js')
  #           return await script({github, context, core})

  #     - name: Run jsonlint
  #       run: find rules -name '*.json' -print0 | xargs -0 jsonlint -qw

  #     # - name: Run Super-Linter
  #     #   uses: github/super-linter/slim@v4
  #     #   env:
  #     #     VALIDATE_JSON: true
  #     #     FILTER_REGEX_INCLUDE: rules/.+\.json$
  #     #     # GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  firewall-rules-schema-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Prerequisites
        run: |
          sudo npm install ajv-cli ajv

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
          terraform_version: 1.6.6

      # Initialize Terraform so that script is able to read the schema file
      - name: Terraform Init
        id: init
        run: terraform init -backend=false

      - name: Get list of changed files
        id: get_list_changed_files
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/firewall-rules-shared/get_list_changed_files.js')
            return await script({github, context, core})

      - name: JSON Lint & Schema Validation
        id: json_lint_and_schema_validation
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/firewall-rules-schema-check/validate_schema_changed_files.js')
            const changedFiles = steps.get_list_changed_files.outputs.changedFiles 
            return await script({github, context, core, changedFiles})
        continue-on-error: true

      - name: Check for JSON Lint Errors
        id: check_for_json_lint_errors
        if: steps.json_lint_and_schema_validation.outputs.jsonLintErrors
        uses: actions/github-script@v7
        with:
          script: |
            const errors = JSON.parse('${{ steps.json_lint_and_schema_validation.outputs.jsonLintErrors }}');
            if (errors.length > 0) {
              console.log("JSON Lint Errors found in the following files:");
              errors.forEach(error => {
                console.log(`- ${error.filename}: ${error.error}`);
              });
              core.setFailed("JSON Lint Errors found");
            }

  firewall-rules-opa-check:
    needs: [firewall-rules-schema-check]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

  pull-request-approver:
    runs-on: ubuntu-latest
    needs: [
        # firewall-rules-lint,
        firewall-rules-schema-check,
        firewall-rules-opa-check,
      ]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
